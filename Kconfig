# Root-level Kconfig for M4G BLE Bridge
# This makes the menu appear at the top level in menuconfig.

menu "M4G Bridge Options"

menu "Platform Configuration"
    choice M4G_TARGET
        prompt "Target Platform"
        default M4G_TARGET_ESP32S3
        help
            Select the target platform for the M4G BLE Bridge.

    config M4G_TARGET_ESP32S3
        bool "ESP32-S3 (native USB host)"
        help
            Build for ESP32-S3 with native USB OTG host capabilities.
            Supports dual-device CharaChorder and standard keyboards.

    config M4G_TARGET_NRF52840
        bool "nRF52840 + MAX3421E"
        help
            Build for nRF52840 SoC with external MAX3421E USB host controller.
            Requires custom hardware with MAX3421E connected via SPI.
    endchoice

    # nRF52840 specific configuration
    menu "nRF52840 + MAX3421E Configuration"
        depends on M4G_TARGET_NRF52840
        
        config M4G_MAX_DEVICES
            int "Max simultaneous USB devices"
            range 1 4
            default 2
            help
                Maximum number of USB HID devices that can be connected simultaneously.
                
        config M4G_MAX3421E_SPI_FREQ
            int "MAX3421E SPI frequency (Hz)"
            range 1000000 16000000
            default 8000000
            help
                SPI clock frequency for communication with MAX3421E.
                Higher frequencies may improve performance but check signal integrity.
                
        config M4G_MAX3421E_INT_GPIO
            int "MAX3421E interrupt GPIO"
            range 0 47
            default 3
            help
                GPIO pin connected to MAX3421E INT output.
                
        config M4G_MAX3421E_CS_GPIO
            int "MAX3421E chip select GPIO"
            range 0 47
            default 4
            help
                GPIO pin for MAX3421E SPI chip select.
                
        config M4G_MAX3421E_RESET_GPIO
            int "MAX3421E reset GPIO (-1 to disable)"
            range -1 47
            default -1
            help
                GPIO pin connected to MAX3421E reset input. Set to -1 if not connected.
                
        config M4G_NRF52840_SPI_INSTANCE
            int "SPI instance (0, 1, or 2)"
            range 0 2
            default 0
            help
                nRF52840 SPI instance to use for MAX3421E communication.
    endmenu
endmenu

config M4G_ENABLE_ARROW_MOUSE
    bool "Enable arrow keys -> mouse movement mapping"
    default y
    help
        When enabled, the bridge will translate arrow keys into relative mouse
        movements. Disable to pass arrow keys through unchanged.

config M4G_ENABLE_DUPLICATE_SUPPRESSION
    bool "Suppress duplicate consecutive HID reports"
    default y
    help
        When enabled, identical consecutive keyboard/mouse reports will not be
        re-sent over BLE to reduce bandwidth and power.

config M4G_LOG_PERSISTENCE
    bool "Persist logs to NVS"
    default y if M4G_BOARD_QTPY
    default n if M4G_BOARD_DEVKIT
    help
        Controls whether logs are appended to an NVS blob for retrieval on next boot.
        Default: enabled for QT Py board, disabled for DevKit.

config M4G_LOG_BUFFER_SIZE
    int "In-RAM log staging buffer size (bytes)"
    depends on M4G_LOG_PERSISTENCE
    range 256 4096
    default 1024
    help
        Size of the RAM buffer used to stage log lines before flushing to NVS.

config M4G_LOG_FLUSH_THRESHOLD
    int "Flush threshold (bytes)"
    depends on M4G_LOG_PERSISTENCE
    range 64 4096
    default 512
    help
        When the staging buffer reaches this many bytes, it will be flushed to NVS.

config M4G_ASSERT_BLE_HANDLE
    bool "Assert BLE report handle resolved"
    default y
    help
        If enabled, sending a report before the characteristic handle is resolved
        triggers an assert (development aid).

menu "CharaChorder Configuration"
    config M4G_CHARACHORDER_CHORD_DELAY_MS
        int "CharaChorder chord processing delay (ms)"
        range 10 1000
        default 50
        help
            Delay in milliseconds before processing CharaChorder reports to allow
            internal chord processing. This prevents interfering with chord expansion.
            
    config M4G_CHARACHORDER_REQUIRE_BOTH_HALVES
        bool "Require both CharaChorder halves for connection"
        default y
        help
            When enabled, CharaChorder devices require both keyboard halves to be
            detected before being considered "connected".
            
    config M4G_CHARACHORDER_RAW_MODE
        bool "CharaChorder raw mode (disable chord processing)"
        default n
        help
            When enabled, passes CharaChorder reports through unchanged without
            any chord processing delay. Use for debugging or special applications.
endmenu

config M4G_STACK_WATERMARK_PERIOD_MS
    int "Stack watermark log period (ms)"
    range 0 600000
    default 30000
    help
        Period for logging stack high-water marks. 0 disables periodic logging.

config M4G_STACK_WATERMARK_MAX_TASKS
    int "Max tasks tracked for stack watermark"
    range 4 64
    default 24
    help
        Maximum number of tasks whose high-water marks are sampled (static array size).

config M4G_IDLE_SLEEP_TIMEOUT_MS
    int "Idle light-sleep timeout (ms)"
    range 0 3600000
    default 60000
    help
        If >0, when there is no BLE connection and no USB HID devices for this duration, the
        system will enter light sleep to save power until a wake source triggers.

config M4G_ENABLE_DIAG_GATT
    bool "Enable diagnostic GATT characteristic"
    default y
    help
        Adds a diagnostic characteristic that returns a status snapshot when read.

config M4G_DIAG_TASK_STACK_SIZE
    int "Diagnostics task stack size (bytes)"
    range 1024 8192
    default 4096
    help
        Stack size for the optional diagnostics periodic task (m4g_diag). Increase if you
        see stack overflow logs referencing the m4g_diag task.

menu "Board Configuration"

choice M4G_BOARD_SELECT
    prompt "Target board"
    default M4G_BOARD_DEVKIT
    help
        Select the hardware variant to apply sensible defaults for GPIOs.

config M4G_BOARD_DEVKIT
    bool "ESP32-S3 DevKit"

config M4G_BOARD_QTPY
    bool "Adafruit QT Py ESP32-S3"

endchoice

choice M4G_LED_TYPE
    prompt "LED type"
    default M4G_LED_TYPE_NEOPIXEL if M4G_BOARD_DEVKIT
    default M4G_LED_TYPE_NEOPIXEL if M4G_BOARD_QTPY
    help
        Select style of status LED.
    config M4G_LED_TYPE_NONE
        bool "None"
    config M4G_LED_TYPE_SIMPLE
        bool "Simple GPIO (future)"
    config M4G_LED_TYPE_NEOPIXEL
        bool "NeoPixel / WS2812"
endchoice

config M4G_LED_DATA_GPIO
    int "LED data GPIO"
    default 48 if M4G_BOARD_DEVKIT
    default 38 if M4G_BOARD_QTPY
    range 0 48
    help
        GPIO output driving the status LED (NeoPixel or single LED).

config M4G_LED_POWER_GPIO
    int "LED power enable GPIO (-1 to disable)"
    default -1 if M4G_BOARD_DEVKIT
    default -1 if M4G_BOARD_QTPY
    default -1
    range -1 48
    help
        Optional power/enable pin for LED. Set -1 if not used.

config M4G_VBUS_ENABLE_GPIO
    int "VBUS enable GPIO (-1 if none)"
    default -1
    range -1 48
    help
        Optional GPIO controlling a load switch to source 5V for USB host. -1 disables.

endmenu

endmenu
