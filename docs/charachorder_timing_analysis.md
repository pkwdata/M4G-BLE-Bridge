# CharaChorder Timing Analysis & Configuration Recommendations

## Overview
This document analyzes the CharaChorder DeviceManager repository to identify firmware options, timing configurations, and settings that should be aligned with the M4G BLE Bridge implementation.

## Key Findings from DeviceManager Repository

### 1. **Chord Detection Timing**

#### ChordHud Component (Chord Quality Metrics)
Location: `src/lib/charrecorder/ChordHud.svelte`

The CharaChorder uses **deviation metrics** to measure chord quality:
```typescript
function getPercent(deviation: number, inputCount: number, perfect: number, fail: number) {
  const failAdjusted = fail * inputCount;
  const perfectAdjusted = perfect * inputCount;
  return Math.min(1, Math.max(0, 
    Math.max(0, deviation - perfectAdjusted) / (failAdjusted - perfectAdjusted)
  ));
}
```

**Chord Quality Thresholds:**
- **Perfect Press Timing**: `10ms * inputCount` (e.g., 40ms for 4-key chord)
- **Acceptable Press Timing**: `25ms * inputCount` (e.g., 100ms for 4-key chord)
- **Perfect Release Timing**: `10ms * inputCount`
- **Acceptable Release Timing**: `18ms * inputCount`

**Press/Release deviation display:**
```svelte
title="Press: {deviation[0]}ms, Release: {deviation[1]}ms"
```

**Key Insight**: CharaChorder firmware measures BOTH press deviation and release deviation separately, tracking the time spread between the first and last key in a chord.

---

### 2. **Robot Detection Threshold**

Location: `src/lib/charrecorder/core/plugins/chords.ts`

```typescript
const ROBOT_THRESHOLD = // value used to detect CharaChorder output vs human input

clearTimeout(this.timeout);
if (replay.stepper.held.size === 0) {
  this.timeout = setTimeout(() => {
    // Process accumulated tokens after timeout
  }, ROBOT_THRESHOLD);
}
```

**Analysis**: The DeviceManager uses a "robot threshold" timeout to distinguish between:
- **Human Input**: Keys pressed/released by the user
- **Robot/CharaChorder Output**: Chords generated by the device firmware

This aligns with our **CONFIG_M4G_CHARACHORDER_CHORD_DELAY_MS=15** setting.

---

### 3. **Configuration System**

#### Settings Metadata Structure
Location: `src/lib/meta/types/meta.ts`

```typescript
export interface SettingsItemMeta {
  id: number;
  description?: string;
  enum?: string[];          // For enumerated options
  range: [number, number];  // Min/max values
  step?: number;            // Increment step
  unit?: string;            // ms, %, etc.
  inverse?: number;         // For inverted values (e.g., delay → frequency)
  scale?: number;           // Scaling factor
}
```

**Units Used:**
- `"ms"` - Milliseconds (timing)
- `"H"` - Hex/Color values
- `"S"` - String values
- `"B"` - Boolean values
- `"%"` - Percentage values

---

### 4. **Serial Communication Protocol**

#### Device Commands
Location: `src/lib/serial/device.ts`

**Chord Management:**
```typescript
// Get chord count
await this.send(1, ["CML", "C0"]);

// Get chord by index
await this.send(2, ["CML", "C1", index.toString()]);

// Get chord phrase for actions
await this.send(1, ["CML", "C2", stringifyChordActions(actions)]);

// Set/update chord
await this.send(1, ["CML", "C3", stringifyChordActions(actions), stringifyPhrase(phrase)]);

// Delete chord
await this.send(1, ["CML", "C4", stringifyChordActions(actions)]);
```

**Settings Management:**
```typescript
// Get setting (profile + id)
await this.send(2, ["VAR", "B1", (id + profile * 0x100).toString(16).toUpperCase()]);

// Set setting (temporary, until reboot)
await this.send(1, ["VAR", "B2", (id + profile * 0x100).toString(16).toUpperCase(), value.toString()]);

// Commit settings permanently (WARNING: Limited write cycles!)
await this.send(1, ["VAR", "B0"]);
```

**Layout/Keymap:**
```typescript
// Set layout key
await this.send(1, ["VAR", "B4", `${profile}${layer}`, id.toString(), action.toString()]);
```

**Device Control:**
```typescript
// Reboot
await this.send(0, ["RST"]);

// Bootloader mode
await this.send(0, ["RST", "BOOTLOADER"]);

// Factory reset types
await this.send(0, ["RST", "FACTORY"]);    // Full reset
await this.send(0, ["RST", "PARAMS"]);     // Reset settings only
await this.send(0, ["RST", "KEYMAPS"]);    // Reset layout only
await this.send(0, ["RST", "CLEARCML"]);   // Clear all chords
await this.send(0, ["RST", "STARTER"]);    // Add starter chords
await this.send(0, ["RST", "FUNC"]);       // Add functional chords
```

---

### 5. **Chord Inference Algorithm**

Location: `src/lib/charrecorder/core/plugins/chords.ts`

```typescript
private infer(human: TextToken[], robo: TextToken[]) {
  const output = robo
    .filter((token) => token.text.length === 1)
    .map((token) => token.text)
    .join("");
    
  this.chords.push({
    id: human.reduce((acc, curr) => Math.max(acc, curr.stamp), 0),
    input: human,
    output,
    deviation: [
      // Press deviation: time from first to last key press
      human.reduce((acc, curr) => Math.max(acc, curr.stamp), 0) -
        human.reduce((acc, curr) => Math.min(acc, curr.stamp), Infinity),
      
      // Release deviation: time from first to last key release
      human.reduce((acc, curr) => Math.max(acc, curr.stamp + (curr.duration ?? 0)), 0) -
        human.reduce((acc, curr) => Math.min(acc, curr.stamp + (curr.duration ?? 0)), Infinity),
    ],
  });
}
```

**Key Insight**: CharaChorder tracks TWO separate deviation metrics:
1. **Press Deviation** - Spread of key press timestamps
2. **Release Deviation** - Spread of key release timestamps

---

### 6. **Debounce & UI Timing**

Location: `src/lib/util/debounce.ts` and various components

```typescript
// Text input debounce for learning mode
textAreaDebounceInMillis: {
  key: "debounceMillis",
  default: 5000,
  parse: (value) => Number(value),
}

// Animation/transition durations
const duration = 150;  // Dialog animations
const animationDuration = 400;  // Layout transitions
const stagger = 80;  // Staggered element animations

// CSS transitions
transition: opacity 150ms ease, scale 250ms ease;
transition: translate 50ms ease;  // Cursor movement
```

**UI Timing Patterns:**
- **Quick feedback**: 50-150ms
- **Standard transitions**: 250ms
- **Complex animations**: 400ms

---

## Recommendations for M4G BLE Bridge

### **1. Align Chord Detection Timing**

**Current Configuration:**
```c
CONFIG_M4G_CHARACHORDER_CHORD_DELAY_MS=15    // Grace period for CharaChorder output
CONFIG_M4G_CHARACHORDER_CHORD_TIMEOUT_MS=500 // Not actively used
```

**Recommended Adjustments:**

```kconfig
# Chord detection timing based on CharaChorder DeviceManager analysis
CONFIG_M4G_CHARACHORDER_CHORD_DELAY_MS
    int "CharaChorder output detection delay (ms)"
    default 15
    range 10 50
    help
      Time to wait for CharaChorder firmware to send chord output after key release.
      CharaChorder uses ~10-25ms for output generation. Setting this too low may
      cause chords to be sent as individual keys; too high adds perceptible latency.
      
      Recommended: 15-25ms (15ms for fast response, 25ms for reliability)

CONFIG_M4G_CHARACHORDER_PRESS_DEVIATION_THRESHOLD_MS
    int "Maximum press deviation for chord detection (ms)"
    default 100
    help
      Maximum time spread between first and last key press in a chord.
      CharaChorder considers <25ms * key_count as acceptable.
      For 4-key chords: 100ms is the upper acceptable limit.

CONFIG_M4G_CHARACHORDER_RELEASE_DEVIATION_THRESHOLD_MS
    int "Maximum release deviation for chord detection (ms)"
    default 72
    help
      Maximum time spread between first and last key release in a chord.
      CharaChorder considers <18ms * key_count as acceptable.
      For 4-key chords: 72ms is the upper acceptable limit.

CONFIG_M4G_CHARACHORDER_PERFECT_PRESS_THRESHOLD_MS
    int "Perfect press deviation threshold (ms)"
    default 40
    help
      Time spread for "perfect" chord press detection.
      CharaChorder uses 10ms * key_count.
      For 4-key chords: 40ms or less is considered perfect.
```

---

### **2. Implement Deviation Tracking**

Add chord quality metrics similar to CharaChorder's HUD:

```c
// In m4g_bridge.c

typedef struct {
    uint32_t first_press_tick;
    uint32_t last_press_tick;
    uint32_t first_release_tick;
    uint32_t last_release_tick;
    uint8_t key_count;
} chord_deviation_t;

static chord_deviation_t s_chord_deviation = {0};

// Update during CHORD_STATE_COLLECTING
static void chord_buffer_add_with_deviation(const m4g_usb_keyboard_state_t *state, TickType_t now) {
    // Track press timestamps
    if (s_chord_buffer_len == 0) {
        s_chord_deviation.first_press_tick = now;
    }
    s_chord_deviation.last_press_tick = now;
    s_chord_deviation.key_count = s_chord_buffer_len + 1;
    
    // Add key to buffer
    chord_buffer_add(state);
}

// Calculate on release
static void chord_log_quality(void) {
    uint32_t press_deviation = s_chord_deviation.last_press_tick - s_chord_deviation.first_press_tick;
    uint32_t release_deviation = s_chord_deviation.last_release_tick - s_chord_deviation.first_release_tick;
    
    uint32_t press_threshold = 10 * s_chord_deviation.key_count;  // 10ms per key
    uint32_t release_threshold = 10 * s_chord_deviation.key_count;
    
    const char* quality = "UNKNOWN";
    if (press_deviation <= press_threshold && release_deviation <= release_threshold) {
        quality = "PERFECT";
    } else if (press_deviation <= (25 * s_chord_deviation.key_count) &&
               release_deviation <= (18 * s_chord_deviation.key_count)) {
        quality = "GOOD";
    } else {
        quality = "ACCEPTABLE";
    }
    
    LOG_AND_SAVE(ENABLE_DEBUG_KEYPRESS_LOGGING, I, BRIDGE_TAG, 
        "Chord quality: %s (press_dev=%ums, release_dev=%ums, keys=%u)",
        quality, press_deviation, release_deviation, s_chord_deviation.key_count);
}
```

---

### **3. Add Configuration System Support**

Consider implementing a settings system similar to CharaChorder's VAR commands:

```c
// Settings IDs
#define M4G_SETTING_CHORD_DELAY_MS           0x01
#define M4G_SETTING_CHORD_PRESS_THRESHOLD    0x02
#define M4G_SETTING_CHORD_RELEASE_THRESHOLD  0x03
#define M4G_SETTING_KEY_REPEAT_ENABLED       0x04
#define M4G_SETTING_KEY_REPEAT_DELAY_MS      0x05
#define M4G_SETTING_KEY_REPEAT_RATE_MS       0x06
#define M4G_SETTING_RAW_MODE_ENABLED         0x07
#define M4G_SETTING_DUPLICATE_SUPPRESSION    0x08

// Runtime-adjustable settings (persist to NVS)
esp_err_t m4g_bridge_set_setting(uint8_t setting_id, uint32_t value);
esp_err_t m4g_bridge_get_setting(uint8_t setting_id, uint32_t *value);
esp_err_t m4g_bridge_commit_settings(void);  // Save to NVS
```

---

### **4. Serial Command Interface (Future Enhancement)**

If USB-to-serial bridge is needed for configuration:

```c
// Command parser similar to CharaChorder
// Commands: VAR B1 <id> - Get setting
//          VAR B2 <id> <value> - Set setting (temporary)
//          VAR B0 - Commit to NVS
//          RST - Reboot
//          RST PARAMS - Reset settings to defaults

esp_err_t m4g_bridge_process_command(const char *cmd, char *response, size_t response_len);
```

---

### **5. Optimize Timing Values**

Based on CharaChorder's proven timings:

| Parameter | Current | Recommended | Rationale |
|-----------|---------|-------------|-----------|
| **Chord Delay** | 15ms | **15-25ms** | CharaChorder output generation time |
| **Chord Timeout** | 500ms | **100-150ms** | Unused in release-based design, but keep for single-key repeat trigger |
| **Key Repeat Delay** | 1000ms | **1000ms** | Standard OS default (good) |
| **Key Repeat Rate** | 50ms | **33-50ms** | 33ms ≈ 30 Hz (Windows default), 50ms ≈ 20 Hz |
| **USB Debounce** | 1000ms | **1000ms** | Hub enumeration stability (good) |
| **Duplicate Suppression** | ON | **ON** | Reduces BLE bandwidth |

---

### **6. Key Repeat Logic Refinement**

Based on the current analysis, key repeat should:

1. **Only activate for single keys** (not chords)
2. **Only trigger if key held >1000ms without release**
3. **Stop immediately on any release event**
4. **Not interfere with chord collection**

```c
// In m4g_bridge_process_key_repeat()
#ifdef CONFIG_M4G_ENABLE_KEY_REPEAT
void m4g_bridge_process_key_repeat(void) {
    TickType_t now = xTaskGetTickCount();
    
    // Don't repeat during chord collection
    if (s_chord_state == CHORD_STATE_COLLECTING || 
        s_chord_state == CHORD_STATE_EXPECTING_OUTPUT) {
        return;
    }
    
    // Single-key timeout: emit after 500ms to allow repeat
    if (s_chord_state == CHORD_STATE_COLLECTING && s_chord_buffer_len == 1) {
        TickType_t collect_duration = now - s_chord_collect_start_tick;
        if (collect_duration >= pdMS_TO_TICKS(CONFIG_M4G_CHARACHORDER_CHORD_TIMEOUT_MS)) {
            // Emit the key to enable repeat
            emit_buffered_single_key();
            s_chord_state = CHORD_STATE_IDLE;
            chord_buffer_reset();
        }
    }
    
    // Standard key repeat logic (existing code)
    // ...
}
#endif
```

---

## CharaChorder-Specific Features to Consider

### **1. Chord Compound Chaining**
Location: `ChordActionEdit.svelte`

CharaChorder supports **compound chords** - chords that are built from other chords. The lookup can go up to 10 levels deep:

```typescript
for (let i = 0; i < 10; i++) {
  if (current.actions[3] !== 0) return;  // Not a compound
  const compound = current.actions.slice(0, 3).reduce((a, b, i) => a | (b << (i * 10)));
  const next = $chordHashes.get(compound);
  if (!next) return null;
  current = next;
  yield next;
}
```

**Recommendation**: Not critical for initial M4G implementation, but could be added later if CharaChorder firmware supports it.

---

### **2. Autospace Feature**
Location: `ChordPhraseEdit.svelte`

```typescript
// Available in firmware >= 2.1.0
let supportsAutospace = semverGte($deviceMeta?.version ?? "0.0.0", "2.1.0");

// Special action codes
const JOIN_ACTION = 574;              // Concatenate without space
const NO_CONCATENATOR_ACTION = 256;   // Suppress autospace
```

**Impact**: This affects how chord outputs should be formatted. M4G bridge just passes through raw HID reports, so this is handled by CharaChorder firmware.

---

### **3. Factory Defaults & Reset Options**

CharaChorder provides multiple reset types:
- **FACTORY**: Complete reset
- **PARAMS**: Settings only
- **KEYMAPS**: Layout only
- **CLEARCML**: Clear all chords
- **STARTER**: Load beginner chord set
- **FUNC**: Load functional chords (shortcuts, etc.)

**Recommendation**: Add similar NVS reset options for M4G bridge settings.

---

## Implementation Priority

### **High Priority** (Immediate)
1. ✅ **15ms chord delay** - Already implemented correctly
2. ✅ **Release-based emission** - Already implemented correctly
3. ⚠️ **Key repeat re-enable** - Needs refinement (single-key + 500ms timeout)
4. ⚠️ **Deviation tracking** - Add logging for chord quality metrics

### **Medium Priority** (Next Release)
1. **Settings system** - Runtime-configurable parameters
2. **NVS persistence** - Save user preferences
3. **Deviation thresholds** - Configurable press/release deviation limits
4. **Serial command interface** - For debugging and configuration

### **Low Priority** (Future)
1. **Compound chord support** - If CharaChorder firmware uses it
2. **Advanced diagnostics** - Chord quality histograms, timing analysis
3. **Web-based config** - Similar to CharaChorder DeviceManager UI

---

## Testing Recommendations

### **1. Chord Quality Testing**
Test with CharaChorder's timing thresholds:

```c
// Log format matching DeviceManager
LOG_AND_SAVE(ENABLE_DEBUG_KEYPRESS_LOGGING, I, BRIDGE_TAG,
    "Chord: %u keys, press_dev=%ums, release_dev=%ums, quality=%s",
    key_count, press_deviation, release_deviation, quality_string);
```

### **2. Edge Cases**
- **Very fast chords** (<10ms press deviation)
- **Sloppy chords** (>100ms press deviation)
- **Single key held** (should trigger repeat after 1000ms)
- **Quick tap** (press+release <100ms)

### **3. BLE Latency**
CharaChorder DeviceManager doesn't show specific BLE timing expectations, but Windows 10/11 BLE typically has:
- **Connection interval**: 7.5-30ms
- **Latency**: 0-4 (skip 0-4 intervals)
- **Supervision timeout**: 4000ms

Current M4G settings are appropriate for low-latency typing.

---

## Conclusion

The M4G BLE Bridge architecture is **well-aligned** with CharaChorder's design:

✅ **15ms chord delay** - Matches CharaChorder's output generation time
✅ **Release-based detection** - Correct approach
✅ **Duplicate suppression** - Good for BLE bandwidth
✅ **Raw mode disable** - Correct for chord processing

**Key improvement needed:**
- Re-enable key repeat with proper single-key + 500ms timeout logic
- Add optional deviation tracking for diagnostics

**Optional enhancements:**
- Runtime-configurable settings (stored in NVS)
- Chord quality metrics logging
- Serial command interface for debugging

---

## References

- **CharaChorder DeviceManager**: https://github.com/CharaChorder/DeviceManager
- **Chord Timing**: `src/lib/charrecorder/ChordHud.svelte` (lines 9-23)
- **Chord Detection**: `src/lib/charrecorder/core/plugins/chords.ts` (lines 24-104)
- **Device Commands**: `src/lib/serial/device.ts` (lines 319-490)
- **Settings Schema**: `src/lib/meta/types/meta.ts` (lines 7-33)
